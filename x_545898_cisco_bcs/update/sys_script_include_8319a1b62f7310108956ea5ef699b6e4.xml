<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_545898_cisco_bcs.Cisco_DAOScript</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description/>
        <name>Cisco_DAOScript</name>
        <script><![CDATA[var Cisco_DAOScript = Class.create();
Cisco_DAOScript.prototype = {
	initialize: function() {
		this.logger = new Cisco_BCS_SNLogger();
		this.table = {
			"processQueue": "x_545898_cisco_bcs_cisco_import_queue",
			"fieldNoticesDump": "x_545898_cisco_bcs_cisco_field_notices_dump",
			"securityAdvisoriesDump": "x_545898_cisco_bcs_cisco_security_advisories_dump",
			"softwareLifecycleDump": "x_545898_cisco_bcs_cisco_software_lifecycle_dump",
			"hardwareLifecycleDump": "x_545898_cisco_bcs_cisco_hardware_lifecycle_dump",
			"fieldNotices": "x_545898_cisco_bcs_cisco_field_notices",
			"securityAdvisories": "x_545898_cisco_bcs_cisco_security_advisories",
			"softwareLifecycle": "x_545898_cisco_bcs_cisco_software_lifecycle",
			"hardwareLifecycle": "x_545898_cisco_bcs_cisco_hardware_lifecycle",
			"authentication": "x_545898_cisco_bcs_configuration",
			"assetsDump":"x_545898_cisco_bcs_cisco_assets_dump",
			"devicesDump":"x_545898_cisco_bcs_cisco_devices_dump",
			"assets":"x_545898_cisco_bcs_cisco_assets",
			"devices":"x_545898_cisco_bcs_cisco_devices",
			"softwareLifecycleBulletinsDump" : "x_545898_cisco_bcs_cisco_sw_eox_bulletins_dump",
			"hardwareLifecycleBulletinDump" : "x_545898_cisco_bcs_cisco_hw_eox_bulletins_dump",
			"hardwareLifecycleBulletin" : "x_545898_cisco_bcs_cisco_hw_eox_bulletins",
			"softwareLifecycleBulletin" : "x_545898_cisco_bcs_cisco_sw_eox_bulletins",
			"securityAdvisoriesbulletinDump" : "x_545898_cisco_bcs_cisco_security_advisories_bulletins_dump",
			"fiedlNoticesBulletinDump" : "x_545898_cisco_bcs_fn_bulletins_dump",
			"securityAdvisoryBulletins" : "x_545898_cisco_bcs_cisco_security_advisories_bulletins",
			"fieldNoticesBulletin" : "x_545898_cisco_bcs_cisco_fn_bulletin",
			"cbpDetails": "x_545898_cisco_bcs_cisco_cbp_details",
			"cbpRules": "x_545898_cisco_bcs_cisco_cbp_rules",
			"cbpSummary": "x_545898_cisco_bcs_cisco_cbp_summary",
			"cbpDetailsDump": "x_545898_cisco_bcs_cisco_cbp_details_dump",
			"cbpRulesDump": "x_545898_cisco_bcs_cisco_cbp_rules_dump",
			"cbpSummaryDump": "x_545898_cisco_bcs_cisco_cbp_summary_dump",
			"contractLifecycleDump" : "x_545898_cisco_bcs_cisco_contract_lifecycle_dump",
			"contractLifecycle" : "x_545898_cisco_bcs_cisco_contract_lifecycle"

		};
		this.property = {
			"retentionPeriod": gs.getProperty("x_545898_cisco_bcs.retention.period"),
			"authRec": gs.getProperty("x_545898_cisco_bcs.Authentication.Record") + '',
		};
	},

	insertIntoQueue: function(topic, parameter, payload, bcs_account) {
		try {

			this.logger.debug("Inside Cisco_DAOScript.insertIntoQueue performing insertion into queue.");
			var gr = new GlideRecord(this.table.processQueue);
			gr.initialize();
			gr.topic = topic + '';
			gr.parameter = parameter + '';
			gr.payload = payload + '';
			gr.state = "ready";
			gr.bcs = bcs_account + '';
			gr.insert();
		} catch (e) {
			this.logger.error("Exception caught inside Cisco_DAOScript.insertIntoQueue while insert data into Queue table. Error :- " + e);
		}
	},
	insertIntoIntermediateDump: function(tableName, response) {
		try {
			this.logger.debug("Inside Cisco_DAOScript.insertIntoIntermediateDump performing insertion into " + this.table[tableName]);
			var gr = new GlideRecord(this.table[tableName]);
			gr.initialize();
			var field = '';
			for (var key in response) {
				field = response[key];
				if (field || field == 0) {
					gr[key.toLowerCase()] = (field.constructor === Object || field.constructor === Array) ? JSON.stringify(field) : field + '';
				}
			}
			gr.insert();
		} catch (e) {
			this.logger.error("Exception caught inside Cisco_DAOScript.insertIntoIntermediateDump while inserting data into intermediate dump table. Error :- " + e);
		}
	},
	checkWhetherAnyScheduleJobIsRunningOrNot: function() {
		var grQueue = new GlideRecord("x_545898_cisco_bcs_cisco_import_queue");
		grQueue.addQuery("state", "processing");
		grQueue.query();
		if (grQueue.next())
			return true;
		else
			return false;
	},
	clearApplicationData: function() {
		try {
			this.logger.debug("Inside Cisco_DAOScript.clearApplicationData deleting application data.");
			gs.setProperty("x_545898_cisco_bcs.start.import",false);
			var checkScheduleJob = this.checkWhetherAnyScheduleJobIsRunningOrNot();
			if (!checkScheduleJob) {
				var applicationTables = ["processQueue", "hardwareLifecycle", "softwareLifecycle", "fieldNotices", "securityAdvisories", "assets", "devices", "cbpDetails", "cbpRules", "cbpSummary", "hardwareLifecycleBulletin", "softwareLifecycleBulletin", "securityAdvisoryBulletins", "fieldNoticesBulletin", "contractLifecycle" ];
				for (var i in applicationTables) {
					var gr = new GlideRecord(this.table[applicationTables[i]]);
					gr.deleteMultiple();
				}

				var authRec = new GlideRecord(this.table.authentication);
				if (authRec.get(this.property.authRec)) {
					authRec.name = "";
					authRec.host_name = "";
					authRec.customer_id = "";
					authRec.api_key = "";
					authRec.update();
				}

				/*for filling prperty with empty value*/
				//          var properties = ["", ""];
				//             for (var k in properties)
				//                 gs.setProperty(properties[k], '');

				return true;
			} else				
				return false;


		} catch (e) {
			this.logger.error("Exception Inside Cisco_DAOScript.clearApplicationData() deleting application data." + e);
		}
	},

	deleteProcessQueue: function(){
		try{
			this.logger.debug("Inside Cisco_DAOScript.deleteProcessQueue Deleting data in process queue older than " + retentionPeriod + " day.");

			var queueObj = new GlideRecord(this.table.processQueue);
			queueObj.addEncodedQuery("sys_created_on<=javascript:gs.endOfYesterday()");
			queueObj.deleteMultiple();

		}catch(e){
			this.logger.error("Exception caught inside Cisco_DAOScript.deleteProcessQueue while Deleting data in process queue older than " + retentionPeriod + " days. Error :- "+e);
		}

	},

	getReferenceMapping: function(table_name,field_name,target_data) {
		try{
			this.logger.debug("Inside Cisco_DAOScript.getReferenceMapping mapping reference of tables");
			var grRef = new GlideRecord(this.table[table_name]);
			grRef.addQuery(field_name , target_data);
			grRef.query();
			if(grRef.next())
				return grRef.sys_id;

			this.logger.warn("Inside Cisco_DAOScript.getReferenceMapping Could not find record for "+field_name+" in table "+table_name);
			return "";

		}catch(e){
			this.logger.error("Exception caught inside Cisco_DAOScript.getReferenceMapping while mapping tables. Error :- "+e);
		}
	},

	getDataOfCalculatedFields : function(tableName,reference,matchConfidence,fieldName) {
		try {
			this.logger.debug("Inside Cisco_DAOScript.getDataOfCalculatedFields calculating vulnerable and potentially vulnerable count");
			var count = 0;

				var calculateData = new GlideRecord(this.table[tableName]);
				calculateData.addQuery(fieldName,reference[fieldName]);
				calculateData.addQuery("match_confidence",matchConfidence);
				calculateData.query();
				while(calculateData.next())
					count = count + 1;
				return count;

		}catch(e) {
			this.logger.error("Exception caught inside Cisco_DAOScript.getDataOfCalculatedFields while calculating vulnerable and potentially vulnerable count. Error :- "+e);
		}


	},

	type: 'Cisco_DAOScript'
};]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2020-10-15 13:48:31</sys_created_on>
        <sys_id>8319a1b62f7310108956ea5ef699b6e4</sys_id>
        <sys_mod_count>54</sys_mod_count>
        <sys_name>Cisco_DAOScript</sys_name>
        <sys_package display_value="Cisco BCS Operational Insights" source="x_545898_cisco_bcs">56b8d9362f3310108956ea5ef699b62d</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="Cisco BCS Operational Insights">56b8d9362f3310108956ea5ef699b62d</sys_scope>
        <sys_update_name>sys_script_include_8319a1b62f7310108956ea5ef699b6e4</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2020-11-11 10:28:21</sys_updated_on>
    </sys_script_include>
</record_update>
